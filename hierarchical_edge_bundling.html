<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中国持有型不动产ABS市场 - 综合关系分析图</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #fafbfc;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .main-chart {
            grid-column: 1 / -1;
        }
        
        h1 {
            text-align: center;
            color: #2d3748;
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .node {
            cursor: pointer;
        }
        
        .node text {
            font-size: 11px;
            fill: #2d3748;
            pointer-events: none;
        }
        
        .node--leaf text {
            font-size: 10px;
            fill: #4a5568;
        }
        
        .link {
            fill: none;
            stroke-opacity: 0.4;
            stroke-width: 1.5;
        }
        
        .link:hover {
            stroke-opacity: 0.8;
        }
        
        .legend {
            font-size: 12px;
            fill: #4a5568;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
        }
        
        .controls {
            margin-bottom: 20px;
            text-align: center;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .controls label {
            margin-right: 20px;
            font-size: 14px;
            color: #4a5568;
        }
        
        .controls input[type="range"] {
            width: 200px;
            margin-left: 10px;
        }
        
        .controls select {
            padding: 5px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            margin-left: 10px;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 12px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>中国持有型不动产ABS市场<br>综合关系分析图</h1>
        
        <div class="controls">
            <label>视图模式: 
                <select id="view-mode">
                    <option value="network">网络关系图</option>
                    <option value="sunburst">旭日图</option>
                    <option value="matrix">关系矩阵</option>
                </select>
            </label>
            <label>分组维度: 
                <select id="group-by">
                    <option value="underwriter">按承销商</option>
                    <option value="asset_type">按资产类型</option>
                    <option value="status">按发行状态</option>
                    <option value="scale">按规模分层</option>
                </select>
            </label>
            <label>连接强度: <input type="range" id="connection-slider" min="0.1" max="1" step="0.1" value="0.8"> <span id="connection-value">0.8</span></label>
        </div>
        
        <div class="dashboard">
            <div class="chart-container">
                <div class="chart-title">市场概览</div>
                <div id="overview-metrics"></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">承销商分布</div>
                <svg id="underwriter-chart" width="400" height="300"></svg>
            </div>
            <div class="chart-container">
                <div class="chart-title">资产类型分布</div>
                <svg id="asset-chart" width="400" height="300"></svg>
            </div>
            <div class="chart-container">
                <div class="chart-title">规模时间线</div>
                <svg id="timeline-chart" width="400" height="300"></svg>
            </div>
        </div>
        
        <div class="chart-container main-chart">
            <div class="chart-title">主要关系网络图</div>
            <svg id="main-chart" width="1200" height="600"></svg>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">详细统计信息</div>
            <div id="detailed-stats"></div>
        </div>
    </div>

    <script>
        // 数据解析和处理 - 基于integrated ABS.csv
        const csvData = `Product_Name,Lead_Underwriter,Scale_Billion_Yuan,Status,Application_Date,Approval_Date,Asset_Category,Underlying_Asset_Type,Third_Party_Certification,Special_Features,Issuer
泰康资产-财通-远景新能源持有型不动产资产支持专项计划(碳中和),泰康资产,2.85,已发行,2025-03-31,2025-05-19,持有型不动产ABS,能源设施,碳中和认证,新能源项目,远景新能源
太平洋-世纪互联数据中心持有型不动产资产支持专项计划,太平洋资产,8.6,已发行,2025-02-21,2025-05-09,持有型不动产ABS,数据中心,无认证,数据中心资产,世纪互联
广明高速持有型不动产资产支持专项计划,人保资产,25.3,已发行,2024-11-21,2025-03-12,持有型不动产ABS,高速公路,无认证,基础设施项目,广明高速
中信证券-万国数据2025年第1期数据中心持有型不动产资产支持专项计划,中信证券,16.09,已发行,2024-07-18,2025-01-23,持有型不动产ABS,数据中心,无认证,全国首单数据中心持有型不动产ABS,万国数据
建信住房租赁基金持有型不动产资产支持专项计划,中金公司,11.7,已发行,2024-03-30,2024-07-30,持有型不动产ABS,住房租赁,无认证,住房租赁领域,建信住房租赁基金
平安证券-中国铁建一期持有型不动产资产支持专项计划,平安证券,8.58,已发行,2024-11-26,2024-12-25,持有型不动产ABS,基础设施,无认证,铁建项目,中国铁建
九永高速持有型不动产资产支持专项计划,华泰资管,22.0,已发行,2024-09-23,2024-11-22,持有型不动产ABS,高速公路,无认证,高速公路项目,九永高速
安江高速持有型不动产资产支持专项计划,中金公司,49.56,已发行,2024-06-27,2024-07-22,持有型不动产ABS,高速公路,无认证,高速公路项目,安江高速
华泰-中交路建清西大桥持有型不动产资产支持专项计划,华泰资管,19.6,已发行,2023-11-13,2023-12-11,持有型不动产ABS,基础设施,无认证,首只持有型REITs产品,中交路建
中信证券-越秀商业持有型不动产资产支持专项计划,中信证券,14.3,已发行,2024-09-20,2024-10-28,持有型不动产ABS,商业地产,无认证,商业地产项目,越秀商业
国金资管-新疆国信持有型不动产资产支持专项计划资产支持证券（火电）,国金资管,55.0,已申报,2025-04-30,2025-05-14,持有型不动产ABS,能源设施,无认证,火电项目,新疆国信
东百集团仓储物流持有型不动产资产支持专项计划,中金公司,15.02,已申报,2025-03-31,2025-04-15,持有型不动产ABS,物流仓储,无认证,物流仓储项目,东百集团
国金资管-观博啟城持有型不动产资产支持专项计划（生物医药产业园）,国金资管,4.99,已申报,2025-03-31,2025-04-13,持有型不动产ABS,产业园区,无认证,生物医药产业园,观博啟城
中金凯德商业持有型不动产资产支持专项计划,中金公司,30.0,已申报,2025-03-31,2025-05-22,持有型不动产ABS,商业地产,无认证,商业地产项目,凯德商业
人保资产-中铁诺德持有型不动产资产支持专项计划,人保资产,25.6,已申报,2025-03-31,2025-04-08,持有型不动产ABS,基础设施,无认证,铁建项目,中铁诺德
国金资管-基汇资本持有型不动产资产支持专项计划,国金资管,8.67,已申报,2025-02-19,2025-04-22,持有型不动产ABS,商业地产,无认证,商业地产项目,基汇资本
国金资管-欢乐颂持有型不动产资产支持专项计划,国金资管,6.95,已申报,2024-12-06,2025-03-19,持有型不动产ABS,商业地产,无认证,商业地产项目,欢乐颂`;

        // 解析CSV数据
        const data = d3.csvParse(csvData);
        
        // 数据清理和预处理
        const cleanedData = data.map(d => ({
            ...d,
            Scale_Billion_Yuan: d.Scale_Billion_Yuan ? +d.Scale_Billion_Yuan : 0,
            Lead_Underwriter: d.Lead_Underwriter || '其他',
            Third_Party_Certification: d.Third_Party_Certification === '无认证' ? '无认证' : d.Third_Party_Certification
        }));

        // 数据分析函数
        function analyzeData() {
            const analysis = {
                byUnderwriter: {},
                byAssetType: {},
                byStatus: {},
                byScale: { large: [], medium: [], small: [] },
                timeline: [],
                totalStats: {}
            };

            cleanedData.forEach(d => {
                // 按承销商分组
                if (!analysis.byUnderwriter[d.Lead_Underwriter]) {
                    analysis.byUnderwriter[d.Lead_Underwriter] = {
                        products: [],
                        totalScale: 0,
                        count: 0
                    };
                }
                analysis.byUnderwriter[d.Lead_Underwriter].products.push(d);
                analysis.byUnderwriter[d.Lead_Underwriter].totalScale += d.Scale_Billion_Yuan;
                analysis.byUnderwriter[d.Lead_Underwriter].count++;

                // 按资产类型分组
                if (!analysis.byAssetType[d.Underlying_Asset_Type]) {
                    analysis.byAssetType[d.Underlying_Asset_Type] = {
                        products: [],
                        totalScale: 0,
                        count: 0
                    };
                }
                analysis.byAssetType[d.Underlying_Asset_Type].products.push(d);
                analysis.byAssetType[d.Underlying_Asset_Type].totalScale += d.Scale_Billion_Yuan;
                analysis.byAssetType[d.Underlying_Asset_Type].count++;

                // 按状态分组
                if (!analysis.byStatus[d.Status]) {
                    analysis.byStatus[d.Status] = {
                        products: [],
                        totalScale: 0,
                        count: 0
                    };
                }
                analysis.byStatus[d.Status].products.push(d);
                analysis.byStatus[d.Status].totalScale += d.Scale_Billion_Yuan;
                analysis.byStatus[d.Status].count++;

                // 按规模分层
                if (d.Scale_Billion_Yuan >= 30) {
                    analysis.byScale.large.push(d);
                } else if (d.Scale_Billion_Yuan >= 10) {
                    analysis.byScale.medium.push(d);
                } else {
                    analysis.byScale.small.push(d);
                }

                // 时间线数据
                if (d.Application_Date) {
                    analysis.timeline.push({
                        date: new Date(d.Application_Date),
                        product: d,
                        scale: d.Scale_Billion_Yuan
                    });
                }
            });

            // 排序时间线
            analysis.timeline.sort((a, b) => a.date - b.date);

            // 总体统计
            analysis.totalStats = {
                totalProducts: cleanedData.length,
                totalScale: cleanedData.reduce((sum, d) => sum + d.Scale_Billion_Yuan, 0),
                avgScale: cleanedData.reduce((sum, d) => sum + d.Scale_Billion_Yuan, 0) / cleanedData.length,
                issuedCount: cleanedData.filter(d => d.Status === '已发行').length,
                pendingCount: cleanedData.filter(d => d.Status === '已申报').length,
                greenCount: cleanedData.filter(d => d.Third_Party_Certification === '碳中和认证').length,
                uniqueUnderwriters: Object.keys(analysis.byUnderwriter).length,
                uniqueAssetTypes: Object.keys(analysis.byAssetType).length
            };

            return analysis;
        }

        // 创建可视化组件
        class ComprehensiveVisualization {
            constructor() {
                this.data = analyzeData();
                this.colors = {
                    underwriter: ['#3b82f6', '#8b5cf6', '#ef4444', '#f59e0b', '#10b981', '#06b6d4', '#f97316', '#ec4899'],
                    assetType: ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22'],
                    status: { '已发行': '#10b981', '已申报': '#f59e0b' },
                    scale: { large: '#ef4444', medium: '#f59e0b', small: '#10b981' }
                };
                this.tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0);
            }

            init() {
                this.createOverviewMetrics();
                this.createUnderwriterChart();
                this.createAssetTypeChart();
                this.createTimelineChart();
                this.createMainNetworkChart();
                this.createDetailedStats();
            }

            createOverviewMetrics() {
                const stats = this.data.totalStats;
                const container = d3.select("#overview-metrics");
                
                const metrics = [
                    { label: "总产品数", value: stats.totalProducts + "只", color: "#667eea" },
                    { label: "总规模", value: stats.totalScale.toFixed(1) + "亿元", color: "#764ba2" },
                    { label: "平均规模", value: stats.avgScale.toFixed(1) + "亿元", color: "#f093fb" },
                    { label: "承销机构", value: stats.uniqueUnderwriters + "家", color: "#f5576c" }
                ];

                const metricCards = container.selectAll(".metric-card")
                    .data(metrics)
                    .enter()
                    .append("div")
                    .attr("class", "metric-card")
                    .style("background", d => `linear-gradient(135deg, ${d.color} 0%, ${d.color}aa 100%)`);

                metricCards.append("div")
                    .attr("class", "metric-value")
                    .text(d => d.value);

                metricCards.append("div")
                    .attr("class", "metric-label")
                    .text(d => d.label);
            }

            createUnderwriterChart() {
                const svg = d3.select("#underwriter-chart");
                const margin = { top: 20, right: 20, bottom: 60, left: 60 };
                const width = 400 - margin.left - margin.right;
                const height = 300 - margin.top - margin.bottom;

                const g = svg.append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const underwriters = Object.entries(this.data.byUnderwriter)
                    .sort((a, b) => b[1].totalScale - a[1].totalScale);

                const x = d3.scaleBand()
                    .domain(underwriters.map(d => d[0]))
                    .range([0, width])
                    .padding(0.1);

                const y = d3.scaleLinear()
                    .domain([0, d3.max(underwriters, d => d[1].totalScale)])
                    .range([height, 0]);

                // 绘制柱状图
                g.selectAll(".bar")
                    .data(underwriters)
                    .enter()
                    .append("rect")
                    .attr("class", "bar")
                    .attr("x", d => x(d[0]))
                    .attr("width", x.bandwidth())
                    .attr("y", d => y(d[1].totalScale))
                    .attr("height", d => height - y(d[1].totalScale))
                    .attr("fill", (d, i) => this.colors.underwriter[i % this.colors.underwriter.length])
                    .on("mouseover", (event, d) => {
                        this.showTooltip(event, `${d[0]}<br/>规模: ${d[1].totalScale.toFixed(1)}亿元<br/>产品数: ${d[1].count}只`);
                    })
                    .on("mouseout", () => this.hideTooltip());

                // 添加坐标轴
                g.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x))
                    .selectAll("text")
                    .style("text-anchor", "end")
                    .attr("dx", "-.8em")
                    .attr("dy", ".15em")
                    .attr("transform", "rotate(-45)")
                    .style("font-size", "10px");

                g.append("g")
                    .call(d3.axisLeft(y).tickFormat(d => d + "亿"));

                // 添加标签
                g.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 0 - margin.left)
                    .attr("x", 0 - (height / 2))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .style("font-size", "12px")
                    .text("发行规模(亿元)");
            }

            createAssetTypeChart() {
                const svg = d3.select("#asset-chart");
                const width = 400;
                const height = 300;
                const radius = Math.min(width, height) / 2 - 20;

                const g = svg.append("g")
                    .attr("transform", `translate(${width/2},${height/2})`);

                const assetTypes = Object.entries(this.data.byAssetType);
                
                const pie = d3.pie()
                    .value(d => d[1].totalScale)
                    .sort(null);

                const arc = d3.arc()
                    .innerRadius(radius * 0.4)
                    .outerRadius(radius);

                const arcs = g.selectAll(".arc")
                    .data(pie(assetTypes))
                    .enter()
                    .append("g")
                    .attr("class", "arc");

                arcs.append("path")
                    .attr("d", arc)
                    .attr("fill", (d, i) => this.colors.assetType[i % this.colors.assetType.length])
                    .on("mouseover", (event, d) => {
                        this.showTooltip(event, `${d.data[0]}<br/>规模: ${d.data[1].totalScale.toFixed(1)}亿元<br/>产品数: ${d.data[1].count}只`);
                    })
                    .on("mouseout", () => this.hideTooltip());

                // 添加标签
                arcs.append("text")
                    .attr("transform", d => `translate(${arc.centroid(d)})`)
                    .attr("dy", ".35em")
                    .style("text-anchor", "middle")
                    .style("font-size", "10px")
                    .text(d => d.data[1].count > 1 ? d.data[0] : "");
            }

            createTimelineChart() {
                const svg = d3.select("#timeline-chart");
                const margin = { top: 20, right: 20, bottom: 40, left: 60 };
                const width = 400 - margin.left - margin.right;
                const height = 300 - margin.top - margin.bottom;

                const g = svg.append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const timeline = this.data.timeline;
                
                const x = d3.scaleTime()
                    .domain(d3.extent(timeline, d => d.date))
                    .range([0, width]);

                const y = d3.scaleLinear()
                    .domain([0, d3.max(timeline, d => d.scale)])
                    .range([height, 0]);

                // 绘制散点图
                g.selectAll(".dot")
                    .data(timeline)
                    .enter()
                    .append("circle")
                    .attr("class", "dot")
                    .attr("cx", d => x(d.date))
                    .attr("cy", d => y(d.scale))
                    .attr("r", 4)
                    .attr("fill", d => this.colors.status[d.product.Status])
                    .on("mouseover", (event, d) => {
                        this.showTooltip(event, `${d.product.Product_Name}<br/>申报日期: ${d.date.toLocaleDateString()}<br/>规模: ${d.scale}亿元`);
                    })
                    .on("mouseout", () => this.hideTooltip());

                // 添加坐标轴
                g.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%Y-%m")));

                g.append("g")
                    .call(d3.axisLeft(y).tickFormat(d => d + "亿"));

                // 添加标签
                g.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 0 - margin.left)
                    .attr("x", 0 - (height / 2))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .style("font-size", "12px")
                    .text("发行规模(亿元)");
            }

            createMainNetworkChart() {
                const svg = d3.select("#main-chart");
                const width = 1200;
                const height = 600;
                
                this.mainSvg = svg;
                this.mainWidth = width;
                this.mainHeight = height;

                // 默认创建力导向图
                this.createForceDirectedGraph(svg, width, height, 'underwriter');
            }
            
            updateMainChart(viewMode, groupBy) {
                if (viewMode === 'network') {
                    this.createForceDirectedGraph(this.mainSvg, this.mainWidth, this.mainHeight, groupBy);
                } else if (viewMode === 'sunburst') {
                    this.createSunburstChart(this.mainSvg, this.mainWidth, this.mainHeight, groupBy);
                } else if (viewMode === 'matrix') {
                    this.createMatrixChart(this.mainSvg, this.mainWidth, this.mainHeight, groupBy);
                }
            }
            
            createSunburstChart(svg, width, height, groupBy) {
                svg.selectAll("*").remove();
                
                const radius = Math.min(width, height) / 2 - 20;
                const g = svg.append("g")
                    .attr("transform", `translate(${width/2},${height/2})`);
                
                // 根据groupBy创建层次数据
                let hierarchyData;
                if (groupBy === 'underwriter') {
                    hierarchyData = this.createHierarchyByUnderwriter();
                } else if (groupBy === 'asset_type') {
                    hierarchyData = this.createHierarchyByAssetType();
                } else if (groupBy === 'status') {
                    hierarchyData = this.createHierarchyByStatus();
                } else {
                    hierarchyData = this.createHierarchyByScale();
                }
                
                const root = d3.hierarchy(hierarchyData)
                    .sum(d => d.value || 1)
                    .sort((a, b) => b.value - a.value);
                
                const partition = d3.partition()
                    .size([2 * Math.PI, radius]);
                
                partition(root);
                
                const arc = d3.arc()
                    .startAngle(d => d.x0)
                    .endAngle(d => d.x1)
                    .innerRadius(d => d.y0)
                    .outerRadius(d => d.y1);
                
                const color = d3.scaleOrdinal(d3.schemeCategory10);
                
                g.selectAll("path")
                    .data(root.descendants())
                    .enter()
                    .append("path")
                    .attr("d", arc)
                    .attr("fill", d => color(d.data.name))
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 2)
                    .on("mouseover", (event, d) => {
                        this.showTooltip(event, `${d.data.name}<br/>数量: ${d.value}`);
                    })
                    .on("mouseout", () => this.hideTooltip());
                
                // 添加标签
                g.selectAll("text")
                    .data(root.descendants().filter(d => d.depth > 0 && d.value > 0))
                    .enter()
                    .append("text")
                    .attr("transform", d => {
                        const angle = (d.x0 + d.x1) / 2;
                        const radius = (d.y0 + d.y1) / 2;
                        return `rotate(${angle * 180 / Math.PI - 90}) translate(${radius},0) rotate(${angle > Math.PI ? 180 : 0})`;
                    })
                    .attr("dy", "0.35em")
                    .attr("text-anchor", d => (d.x0 + d.x1) / 2 > Math.PI ? "end" : "start")
                    .text(d => d.data.name.length > 8 ? d.data.name.substring(0, 6) + "..." : d.data.name)
                    .style("font-size", "10px")
                    .style("fill", "#333");
            }
            
            createMatrixChart(svg, width, height, groupBy) {
                svg.selectAll("*").remove();
                
                const margin = { top: 80, right: 80, bottom: 80, left: 80 };
                const chartWidth = width - margin.left - margin.right;
                const chartHeight = height - margin.top - margin.bottom;
                
                const g = svg.append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);
                
                // 创建矩阵数据
                const matrix = this.createMatrixData(groupBy);
                const labels = matrix.labels;
                const data = matrix.data;
                
                const cellSize = Math.min(chartWidth / labels.length, chartHeight / labels.length);
                
                const colorScale = d3.scaleSequential(d3.interpolateBlues)
                    .domain([0, d3.max(data.flat())]);
                
                // 绘制矩阵
                const rows = g.selectAll(".row")
                    .data(data)
                    .enter()
                    .append("g")
                    .attr("class", "row")
                    .attr("transform", (d, i) => `translate(0,${i * cellSize})`);
                
                const cells = rows.selectAll(".cell")
                    .data(d => d)
                    .enter()
                    .append("rect")
                    .attr("class", "cell")
                    .attr("x", (d, i) => i * cellSize)
                    .attr("width", cellSize)
                    .attr("height", cellSize)
                    .attr("fill", d => colorScale(d))
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 1)
                    .on("mouseover", (event, d) => {
                        this.showTooltip(event, `关联强度: ${d}`);
                    })
                    .on("mouseout", () => this.hideTooltip());
                
                // 添加行标签
                g.selectAll(".row-label")
                    .data(labels)
                    .enter()
                    .append("text")
                    .attr("class", "row-label")
                    .attr("x", -10)
                    .attr("y", (d, i) => i * cellSize + cellSize / 2)
                    .attr("dy", "0.35em")
                    .attr("text-anchor", "end")
                    .text(d => d.length > 8 ? d.substring(0, 6) + "..." : d)
                    .style("font-size", "10px");
                
                // 添加列标签
                g.selectAll(".col-label")
                    .data(labels)
                    .enter()
                    .append("text")
                    .attr("class", "col-label")
                    .attr("x", (d, i) => i * cellSize + cellSize / 2)
                    .attr("y", -10)
                    .attr("text-anchor", "middle")
                    .attr("transform", (d, i) => `rotate(-45,${i * cellSize + cellSize / 2},-10)`)
                    .text(d => d.length > 8 ? d.substring(0, 6) + "..." : d)
                    .style("font-size", "10px");
            }

            createForceDirectedGraph(svg, width, height, groupBy = 'underwriter') {
                // 清空之前的内容
                svg.selectAll("*").remove();
                
                const nodes = [];
                const links = [];

                // 根据分组维度创建不同的网络结构
                if (groupBy === 'underwriter') {
                    // 产品-承销商网络
                    cleanedData.forEach(d => {
                        nodes.push({
                            id: d.Product_Name,
                            type: 'product',
                            data: d,
                            group: d.Lead_Underwriter
                        });
                    });

                    Object.keys(this.data.byUnderwriter).forEach(underwriter => {
                        nodes.push({
                            id: underwriter,
                            type: 'underwriter',
                            data: this.data.byUnderwriter[underwriter],
                            group: underwriter
                        });
                    });

                    cleanedData.forEach(d => {
                        links.push({
                            source: d.Product_Name,
                            target: d.Lead_Underwriter,
                            type: 'underwriter'
                        });
                    });

                } else if (groupBy === 'asset_type') {
                    // 产品-资产类型网络
                    cleanedData.forEach(d => {
                        nodes.push({
                            id: d.Product_Name,
                            type: 'product',
                            data: d,
                            group: d.Underlying_Asset_Type
                        });
                    });

                    Object.keys(this.data.byAssetType).forEach(assetType => {
                        nodes.push({
                            id: assetType,
                            type: 'asset_type',
                            data: this.data.byAssetType[assetType],
                            group: assetType
                        });
                    });

                    cleanedData.forEach(d => {
                        links.push({
                            source: d.Product_Name,
                            target: d.Underlying_Asset_Type,
                            type: 'asset_type'
                        });
                    });

                } else if (groupBy === 'status') {
                    // 产品-状态网络
                    cleanedData.forEach(d => {
                        nodes.push({
                            id: d.Product_Name,
                            type: 'product',
                            data: d,
                            group: d.Status
                        });
                    });

                    Object.keys(this.data.byStatus).forEach(status => {
                        nodes.push({
                            id: status,
                            type: 'status',
                            data: this.data.byStatus[status],
                            group: status
                        });
                    });

                    cleanedData.forEach(d => {
                        links.push({
                            source: d.Product_Name,
                            target: d.Status,
                            type: 'status'
                        });
                    });

                } else if (groupBy === 'scale') {
                    // 产品-规模分层网络
                    cleanedData.forEach(d => {
                        let scaleCategory;
                        if (d.Scale_Billion_Yuan >= 30) {
                            scaleCategory = '大型(≥30亿)';
                        } else if (d.Scale_Billion_Yuan >= 10) {
                            scaleCategory = '中型(10-30亿)';
                        } else {
                            scaleCategory = '小型(<10亿)';
                        }

                        nodes.push({
                            id: d.Product_Name,
                            type: 'product',
                            data: d,
                            group: scaleCategory
                        });
                    });

                    ['大型(≥30亿)', '中型(10-30亿)', '小型(<10亿)'].forEach(scaleCategory => {
                        const products = cleanedData.filter(d => {
                            if (scaleCategory === '大型(≥30亿)') return d.Scale_Billion_Yuan >= 30;
                            if (scaleCategory === '中型(10-30亿)') return d.Scale_Billion_Yuan >= 10 && d.Scale_Billion_Yuan < 30;
                            return d.Scale_Billion_Yuan < 10;
                        });

                        if (products.length > 0) {
                            nodes.push({
                                id: scaleCategory,
                                type: 'scale',
                                data: {
                                    count: products.length,
                                    totalScale: products.reduce((sum, p) => sum + p.Scale_Billion_Yuan, 0)
                                },
                                group: scaleCategory
                            });
                        }
                    });

                    cleanedData.forEach(d => {
                        let scaleCategory;
                        if (d.Scale_Billion_Yuan >= 30) {
                            scaleCategory = '大型(≥30亿)';
                        } else if (d.Scale_Billion_Yuan >= 10) {
                            scaleCategory = '中型(10-30亿)';
                        } else {
                            scaleCategory = '小型(<10亿)';
                        }

                        links.push({
                            source: d.Product_Name,
                            target: scaleCategory,
                            type: 'scale'
                        });
                    });
                }

                // 创建力导向模拟，增强中心聚集力
                const simulation = d3.forceSimulation(nodes)
                    .force("link", d3.forceLink(links).id(d => d.id).distance(80).strength(1))
                    .force("charge", d3.forceManyBody().strength(-500))
                    .force("center", d3.forceCenter(width / 2, height / 2).strength(1))
                    .force("collision", d3.forceCollide().radius(d => d.type === 'product' ? 8 : 15))
                    .force("x", d3.forceX(width / 2).strength(0.1))
                    .force("y", d3.forceY(height / 2).strength(0.1));

                // 绘制连接线
                const link = svg.append("g")
                    .attr("class", "links")
                    .selectAll("line")
                    .data(links)
                    .enter()
                    .append("line")
                    .attr("stroke", "#999")
                    .attr("stroke-opacity", 0.6)
                    .attr("stroke-width", 2);

                // 绘制节点
                const node = svg.append("g")
                    .attr("class", "nodes")
                    .selectAll("circle")
                    .data(nodes)
                    .enter()
                    .append("circle")
                    .attr("r", d => d.type === 'product' ? 8 : 15)
                    .attr("fill", d => {
                        if (d.type === 'product') {
                            return this.colors.status[d.data.Status];
                        } else if (d.type === 'underwriter') {
                            const index = Object.keys(this.data.byUnderwriter).indexOf(d.id);
                            return this.colors.underwriter[index % this.colors.underwriter.length];
                        } else if (d.type === 'asset_type') {
                            const index = Object.keys(this.data.byAssetType).indexOf(d.id);
                            return this.colors.assetType[index % this.colors.assetType.length];
                        } else if (d.type === 'status') {
                            return this.colors.status[d.id];
                        } else if (d.type === 'scale') {
                            return this.colors.scale[d.id.includes('大型') ? 'large' : d.id.includes('中型') ? 'medium' : 'small'];
                        }
                        return '#999';
                    })
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 2)
                    .call(d3.drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended))
                    .on("mouseover", (event, d) => {
                        if (d.type === 'product') {
                            this.showTooltip(event, `${d.data.Product_Name}<br/>承销商: ${d.data.Lead_Underwriter}<br/>规模: ${d.data.Scale_Billion_Yuan}亿元<br/>资产类型: ${d.data.Underlying_Asset_Type}`);
                        } else if (d.type === 'underwriter') {
                            this.showTooltip(event, `承销商: ${d.id}<br/>产品数: ${d.data.count}只<br/>总规模: ${d.data.totalScale.toFixed(1)}亿元`);
                        } else if (d.type === 'asset_type') {
                            this.showTooltip(event, `资产类型: ${d.id}<br/>产品数: ${d.data.count}只<br/>总规模: ${d.data.totalScale.toFixed(1)}亿元`);
                        } else if (d.type === 'status') {
                            this.showTooltip(event, `发行状态: ${d.id}<br/>产品数: ${d.data.count}只<br/>总规模: ${d.data.totalScale.toFixed(1)}亿元`);
                        } else if (d.type === 'scale') {
                            this.showTooltip(event, `规模分层: ${d.id}<br/>产品数: ${d.data.count}只<br/>总规模: ${d.data.totalScale.toFixed(1)}亿元`);
                        }
                    })
                    .on("mouseout", () => this.hideTooltip());

                // 添加标签
                const label = svg.append("g")
                    .attr("class", "labels")
                    .selectAll("text")
                    .data(nodes)
                    .enter()
                    .append("text")
                    .text(d => {
                        if (d.type === 'product') {
                            // 产品名称简化显示
                            const name = d.id;
                            if (name.length > 15) {
                                return name.substring(0, 12) + "...";
                            }
                            return name;
                        } else {
                            // 分组节点显示完整名称
                            return d.id;
                        }
                    })
                    .style("font-size", d => d.type === 'product' ? "8px" : "12px")
                    .style("font-weight", d => d.type === 'product' ? "normal" : "bold")
                    .style("text-anchor", "middle")
                    .style("fill", "#333")
                    .style("pointer-events", "none");

                // 模拟更新
                simulation.on("tick", () => {
                    // 限制节点在画布范围内
                    node
                        .attr("cx", d => {
                            d.x = Math.max(20, Math.min(width - 20, d.x));
                            return d.x;
                        })
                        .attr("cy", d => {
                            d.y = Math.max(20, Math.min(height - 20, d.y));
                            return d.y;
                        });

                    link
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => d.target.x)
                        .attr("y2", d => d.target.y);

                    label
                        .attr("x", d => d.x)
                        .attr("y", d => d.type === 'product' ? d.y - 12 : d.y + 25);
                });

                // 拖拽函数
                function dragstarted(event, d) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }

                function dragged(event, d) {
                    d.fx = event.x;
                    d.fy = event.y;
                }

                function dragended(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }

                // 存储simulation以便后续更新
                this.simulation = simulation;
            }

            createDetailedStats() {
                const container = d3.select("#detailed-stats");
                const stats = this.data.totalStats;
                
                const statsHtml = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div>
                            <h4>发行状态分布</h4>
                            <div>已发行: ${stats.issuedCount}只 (${(stats.issuedCount/stats.totalProducts*100).toFixed(1)}%)</div>
                            <div>已申报: ${stats.pendingCount}只 (${(stats.pendingCount/stats.totalProducts*100).toFixed(1)}%)</div>
                        </div>
                        <div>
                            <h4>规模分布</h4>
                            <div>大型(≥30亿): ${this.data.byScale.large.length}只</div>
                            <div>中型(10-30亿): ${this.data.byScale.medium.length}只</div>
                            <div>小型(<10亿): ${this.data.byScale.small.length}只</div>
                        </div>
                        <div>
                            <h4>绿色认证</h4>
                            <div>绿色项目: ${stats.greenCount}只</div>
                            <div>传统项目: ${stats.totalProducts - stats.greenCount}只</div>
                            <div>绿色占比: ${(stats.greenCount/stats.totalProducts*100).toFixed(1)}%</div>
                        </div>
                        <div>
                            <h4>市场集中度</h4>
                            <div>承销商数量: ${stats.uniqueUnderwriters}家</div>
                            <div>资产类型: ${stats.uniqueAssetTypes}种</div>
                            <div>平均每家承销商: ${(stats.totalProducts/stats.uniqueUnderwriters).toFixed(1)}只</div>
                        </div>
                    </div>
                `;
                
                container.html(statsHtml);
            }

            showTooltip(event, content) {
                this.tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                this.tooltip.html(content)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            }

            hideTooltip() {
                this.tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            }
            
            // 辅助函数：创建层次数据
            createHierarchyByUnderwriter() {
                return {
                    name: "承销商分布",
                    children: Object.entries(this.data.byUnderwriter).map(([name, data]) => ({
                        name: name,
                        value: data.totalScale,
                        children: data.products.map(p => ({
                            name: p.Product_Name,
                            value: p.Scale_Billion_Yuan
                        }))
                    }))
                };
            }
            
            createHierarchyByAssetType() {
                return {
                    name: "资产类型分布",
                    children: Object.entries(this.data.byAssetType).map(([name, data]) => ({
                        name: name,
                        value: data.totalScale,
                        children: data.products.map(p => ({
                            name: p.Product_Name,
                            value: p.Scale_Billion_Yuan
                        }))
                    }))
                };
            }
            
            createHierarchyByStatus() {
                return {
                    name: "发行状态分布",
                    children: Object.entries(this.data.byStatus).map(([name, data]) => ({
                        name: name,
                        value: data.totalScale,
                        children: data.products.map(p => ({
                            name: p.Product_Name,
                            value: p.Scale_Billion_Yuan
                        }))
                    }))
                };
            }
            
            createHierarchyByScale() {
                return {
                    name: "规模分布",
                    children: [
                        {
                            name: "大型(≥30亿)",
                            value: this.data.byScale.large.reduce((sum, p) => sum + p.Scale_Billion_Yuan, 0),
                            children: this.data.byScale.large.map(p => ({
                                name: p.Product_Name,
                                value: p.Scale_Billion_Yuan
                            }))
                        },
                        {
                            name: "中型(10-30亿)",
                            value: this.data.byScale.medium.reduce((sum, p) => sum + p.Scale_Billion_Yuan, 0),
                            children: this.data.byScale.medium.map(p => ({
                                name: p.Product_Name,
                                value: p.Scale_Billion_Yuan
                            }))
                        },
                        {
                            name: "小型(<10亿)",
                            value: this.data.byScale.small.reduce((sum, p) => sum + p.Scale_Billion_Yuan, 0),
                            children: this.data.byScale.small.map(p => ({
                                name: p.Product_Name,
                                value: p.Scale_Billion_Yuan
                            }))
                        }
                    ]
                };
            }
            
            createMatrixData(groupBy) {
                let labels, data;
                
                if (groupBy === 'underwriter') {
                    labels = Object.keys(this.data.byUnderwriter);
                    data = labels.map(row => 
                        labels.map(col => {
                            if (row === col) return this.data.byUnderwriter[row].count;
                            // 计算共同产品数量或其他关联度
                            return 0;
                        })
                    );
                } else if (groupBy === 'asset_type') {
                    labels = Object.keys(this.data.byAssetType);
                    data = labels.map(row => 
                        labels.map(col => {
                            if (row === col) return this.data.byAssetType[row].count;
                            return 0;
                        })
                    );
                } else {
                    // 默认承销商vs资产类型矩阵
                    const underwriters = Object.keys(this.data.byUnderwriter);
                    const assetTypes = Object.keys(this.data.byAssetType);
                    labels = underwriters;
                    
                    data = underwriters.map(underwriter => 
                        assetTypes.map(assetType => {
                            // 计算该承销商在该资产类型的产品数量
                            return this.data.byUnderwriter[underwriter].products.filter(
                                p => p.Underlying_Asset_Type === assetType
                            ).length;
                        })
                    );
                }
                
                return { labels, data };
            }
        }

        // 初始化可视化
        const visualization = new ComprehensiveVisualization();
        visualization.init();
        
        // 控制器事件
        document.getElementById('connection-slider').addEventListener('input', function() {
            const value = parseFloat(this.value);
            document.getElementById('connection-value').textContent = value;
            // 重新创建网络图以应用新的连接强度
            if (document.getElementById('view-mode').value === 'network') {
                const groupBy = document.getElementById('group-by').value;
                visualization.createForceDirectedGraph(
                    visualization.mainSvg, 
                    visualization.mainWidth, 
                    visualization.mainHeight,
                    groupBy
                );
            }
        });
        
        document.getElementById('view-mode').addEventListener('change', function() {
            const mode = this.value;
            const groupBy = document.getElementById('group-by').value;
            console.log('切换到视图模式:', mode, '分组:', groupBy);
            visualization.updateMainChart(mode, groupBy);
        });
        
        document.getElementById('group-by').addEventListener('change', function() {
            const groupBy = this.value;
            const mode = document.getElementById('view-mode').value;
            console.log('切换分组维度:', groupBy, '视图:', mode);
            
            // 更新主图表（包括网络图）
            visualization.updateMainChart(mode, groupBy);
            
            // 同时更新其他小图表以反映新的分组
            if (groupBy === 'underwriter') {
                // 重新创建承销商图表
                d3.select("#underwriter-chart").selectAll("*").remove();
                visualization.createUnderwriterChart();
            } else if (groupBy === 'asset_type') {
                // 重新创建资产类型图表
                d3.select("#asset-chart").selectAll("*").remove();
                visualization.createAssetTypeChart();
            }
        });
    </script>
</body>
</html> 